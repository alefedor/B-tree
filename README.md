# B-tree
## Описание проекта

Требовалось написать структуру данных, которая хранила пары <Ключ, Значение> и поддерживала бы операции add, del, get и выборку.
При этом структура должна уметь восстанавливаться к предыдущему состоянию в случае, если произошла ошибка во время операции (например, отключили электропитание). Потерь данных при этом происходить не должно.

## Как решалась поставленная задача

Была выбрана структура данных B-tree в качестве основы для проекта. Все дерево полностью хранится в дисковой памяти. В каждой вершине хранятся ключи и указатели (offset-ы) на значения в другом файлы. Поддерживается инвариант, что в начале файла (точнее, после первых 8 байт, про это после) всегда хранится корень для возможности быстрого доступа к нему.

Для того, чтобы можно было обеспечивать восстановление также был реализован журнал. 
Журнал ведется в бинарном виде и после каждой операции начинает записываться с начала. Чтобы знать, сколько операций восстанавливать, в начале хранится это число (при успешном завершении оно обнуляется).

При удалении вершины память, в которой она хранится, будет в дальнейшем переиспользована.
Это достигается тем, что поддерживается список удаленных вершин, и сначала берутся вершины из него и только затем создаются новые в конце файла.
При этом на список расходуется всего 8 байт дополнительной памяти (в начале файла), т.к. все указатели, кроме первого будут содержатся в памяти удаленных вершин.
Таким образом, память в дереве не теряется, но размер дерева при этом не может уменьшаться. Был выбран именно такой способ, т.к. он эффективный (позволяет эффективно управлять удаленной памятью) и универсальный (не использует библиотек и функций, написанных под определенные операционные/файловые системы).

Аналогичным образом реализована работа с памятью в файле с значениями.

Для оптимизации вершины дерева кэшируются в оперативной памяти.

## Интерфейс

Написан Makefile, который компилирует и собирает бинарные файлы. Чтобы запустить его, достаточно команды make.

Имеется конструктор по умолчанию для класса Btree. Нужно передать этому классы три шаблонный параметра: тип ключа, тип значения и минимальное количество потомков в дереве. По умолчанию операции дописываются уже к тому дереву, что есть в файле.
Чтобы удалить файл с деревом и другие лишние файлы, можно использовать make clean

void addElem(const Key &key, const Value &val);

void getElems(const Key &left, const Key &right, std::vector<std::pair<Key, Value> > &res); //search in [left, right]

void delElem(const Key &key);

bool findElem(const Key &key, Value *pval); // return whether the element was found and if is found writes it in pval

Makefile собирает файл main, который можно запустить, чтобы запустить тесты.
Тесты написаны в файле main.cpp